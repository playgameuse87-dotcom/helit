name: Unity Multi Build (Android + Windows + WebGL)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    name: Build LudoDream
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout du projet
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Cache Unity
      - name: Unity Cache
        uses: actions/cache@v3
        with:
          path: ~/.cache/unity3d
          key: Unity-${{ runner.os }}

      # 3. Installer Unity + modules
      - name: Install Unity
        uses: game-ci/unity-installer@v3
        with:
          unityVersion: 2022.3.20f1
          modules: android,windows,webgl

      # ------------------------
      # ðŸ”¶ BUILD ANDROID
      # ------------------------
      - name: Build Android
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        with:
          targetPlatform: Android
          buildName: LudoDreamAndroid
          androidExportType: androidPackage
          allowDirtyBuild: true

      - name: Upload Android Build
        uses: actions/upload-artifact@v3
        with:
          name: Android-Build
          path: build/Android/

      # ------------------------
      # ðŸ”· BUILD WINDOWS
      # ------------------------
      - name: Build Windows
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        with:
          targetPlatform: StandaloneWindows64
          buildName: LudoDreamWindows
          allowDirtyBuild: true

      - name: Upload Windows Build
        uses: actions/upload-artifact@v3
        with:
          name: Windows-Build
          path: build/StandaloneWindows64/

      # ------------------------
      # ðŸŸ© BUILD WEBGL
      # ------------------------
      - name: Build WebGL
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        with:
          targetPlatform: WebGL
          buildName: LudoDreamWebGL
          allowDirtyBuild: true

      - name: Upload WebGL Build
        uses: actions/upload-artifact@v3
        with:
          name: WebGL-Build
          path: build/WebGL/

  # ------------------------
  # ðŸ“¦ RELEASE FINAL
  # ------------------------
  release:
    name: Publish Release
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download Builds
        uses: actions/download-artifact@v3
        with:
          path: ./AllBuilds

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: ./AllBuilds/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
